<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.jfshare.product.model.mapper.manual.ManualTbProductCardMapper">

    <resultMap id="statisticsResultMap" type="com.jfshare.product.model.manual.ProductCardStatisticsModel">
        <result column="product_id" property="productId" jdbcType="VARCHAR"/>
        <result column="name" property="productName" jdbcType="VARCHAR"/>
        <result column="sku_num" property="skuNum" jdbcType="VARCHAR"/>
        <result column="total" property="total" jdbcType="INTEGER"/>
        <result column="unused" property="unusedNum" jdbcType="INTEGER"/>
        <result column="create_time" property="createTime" jdbcType="TIMESTAMP"/>
    </resultMap>

    <resultMap id="aldCaptchaItemMap" type="com.jfshare.finagle.thrift.product.AldCaptchaItem">
        <result column="id" property="productId" jdbcType="VARCHAR"/>
        <result column="name" property="productName" jdbcType="VARCHAR"/>
        <result column="sold_num" property="aldSold" jdbcType="INTEGER"/>
        <result column="checked_num" property="aldCaptcha" jdbcType="INTEGER"/>
    </resultMap>

    <select id="selectAvailableCard" parameterType="map" resultMap="com.jfshare.product.model.mapper.TbProductCardMapper.BaseResultMap">
        select
        <include refid="com.jfshare.product.model.mapper.TbProductCardMapper.Base_Column_List"/>
        from tb_product_card
        <where>
            and product_id = #{productId} and state != 1 and transaction_id = #{transactionId}
        </where>
    </select>

    <update id="lockProductCard" parameterType="map">
		UPDATE tb_product_card
		SET transaction_id = #{transactionId}, state = 2, buyer_id = #{buyerId}, sold_time = CURRENT_TIMESTAMP
		WHERE state = 1 and product_id = #{productId}
		ORDER BY create_time asc
		limit #{num}
	</update>

    <update id="releaseProductCard" parameterType="map">
		update tb_product_card
		SET transaction_id = '', state = 1, buyer_id = 0, sold_time = null
		WHERE transaction_id = #{transactionId} and product_id = #{productId}
	</update>

    <select id="queryProductCardViewListCount" parameterType="map" resultType="int">
        select
        count(*)
        from tb_product_card
        <where>
            and product_id = #{productId} and seller_id = #{sellerId}
            <if test="cardNumber != null">
                and card_number like concat('%',#{cardNumber} ,'%')
            </if>
            <if test="state != 0">
                and state = #{state}
            </if>
        </where>
    </select>

    <select id="queryProductCardViewList" parameterType="map" resultMap="com.jfshare.product.model.mapper.TbProductCardMapper.BaseResultMap">
        select
        <include refid="com.jfshare.product.model.mapper.TbProductCardMapper.Base_Column_List"/>
        from tb_product_card
        <where>
            and product_id = #{productId,jdbcType=VARCHAR} and seller_id = #{sellerId}
            <if test="cardNumber != null">
                and card_number like concat('%',#{cardNumber} ,'%')
            </if>
            <if test="state != 0">
                and state = #{state}
            </if>
        </where>
        order by id
        limit #{start}, #{count}
    </select>

    <select id="statisticsProductCard" parameterType="map" resultMap="statisticsResultMap">
		SELECT
          t.product_id,
          t.sku_num,
          p.name,
          t.create_time,
          COUNT(*) total,
          SUM(
            CASE
              WHEN t.state = 1
              THEN 1
              ELSE 0
            END) AS unused
        FROM
          tb_product_card t , tb_product p
          <where>
              AND t.product_id = p.id AND t.seller_id = #{sellerId}
              <if test="productName != null">
                  AND p.name like concat('%',#{productName} ,'%')
              </if>
          </where>
        GROUP BY t.product_id, t.sku_num
        ORDER BY t.product_id asc, create_time asc
        LIMIT #{start}, #{count}
	</select>

    <select id="statisticsProductCardCount" parameterType="map" resultType="int">
        SELECT
        COUNT(*)
        FROM
        tb_product_card t , tb_product p
        <where>
            AND t.product_id = p.id AND t.seller_id = #{sellerId}
            <if test="productName != null">
                AND p.name like concat('%',#{productName} ,'%')
            </if>
        </where>
    </select>

    <select id="sellerProductCardCount" parameterType="map" resultType="int">
        SELECT
        COUNT(*)
        FROM
        tb_product p, tb_product_card_statistics s
        <where>
            AND s.product_id = p.id AND s.seller_id = #{sellerId}
        </where>
    </select>
    
    <select id="sellerProductCardList" parameterType="map" resultMap="aldCaptchaItemMap">
        SELECT
        p.id, p.name, sum(s.sold_num) sold_num, sum(s.checked_num) checked_num
        FROM
        tb_product p, tb_product_card_statistics s
        <where>
            AND s.product_id = p.id AND s.seller_id = #{sellerId}
        </where>
        GROUP BY p.name
        ORDER BY checked_num desc, sold_num asc
        LIMIT #{start}, #{count}
    </select>
    
    <select id="sellerProductCardDayCount" parameterType="map" resultType="int">
      select * from tb_product_card_statistics
    </select>

    <select id="sellerProductCardDayList" parameterType="map" resultMap="aldCaptchaItemMap">
      select * from tb_product_card_statistics
    </select>

    <select id="getProductCardCount" parameterType="map" resultType="int">
        select
        <if test="state == 2">
            COALESCE(sum(s.sold_num),0)
        </if>
        <if test="state == 3">
            COALESCE(sum(s.checked_num),0)
        </if>

        from tb_product p, tb_product_card_statistics s
        <where>
            and p.id = s.product_id and s.seller_id = #{sellerId}
            <if test="productId != null">
              and s.product_id = #{productId}
            </if>
            <if test="day != null">
              and s.statistics_date = #{day}
            </if>
            <if test="month != null">
              and LEFT(s.`statistics_date`,7) = #{month}
            </if>
        </where>

    </select>

    <select id="queryProductCardCheckCount" parameterType="map" resultType="int">
        SELECT
        COUNT(*)
        FROM
        tb_product p, tb_product_card c
        <where>
            AND c.product_id = p.id AND c.seller_id = #{sellerId} and c.product_id = #{productId} and c.state = 3
            and DATE_FORMAT(c.`check_time`,'%Y-%m') = #{month}
        </where>
    </select>

    <select id="queryProductCardCheckList" parameterType="map" resultMap="com.jfshare.product.model.mapper.TbProductCardMapper.BaseResultMap">
        SELECT
        c.*
        FROM
        tb_product p, tb_product_card c
        <where>
            AND c.product_id = p.id AND c.seller_id = #{sellerId} and c.product_id = #{productId} and c.state = 3
            and DATE_FORMAT(c.checked_time,'%Y-%m') = #{month}
            order by c.checked_time DESC
            LIMIT #{start}, #{count}
        </where>
    </select>
</mapper>